---
- name: "Load pipx tools configuration"
  ansible.builtin.include_vars:
    file: "{{ role_path }}/config/common/pipx-tools.yml"
    name: pipx_tools_config

- name: "Install pipx tools"
  ansible.builtin.shell: |
    pipx install --python {{ ansible_env.HOME }}/.pyenv/versions/{{ item.python_version | default(python_version) }}/bin/python {{ item.name }}
  loop: "{{ pipx_tools_config.tools }}"
  changed_when: false
  when: pipx_tools_config.tools | length > 0

- name: "Ensure menv venv directory exists"
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.menv/venvs"
    state: directory
    mode: "0755"

- name: "Create mlx-lm venv"
  ansible.builtin.shell: |
    uv venv {{ ansible_env.HOME }}/.menv/venvs/mlx-lm
  args:
    creates: "{{ ansible_env.HOME }}/.menv/venvs/mlx-lm"
    chdir: "{{ repo_root_path }}"
  when: repo_root_path is defined

- name: "Install mlx dependency-group into mlx-lm venv"
  ansible.builtin.shell: |
    UV_PROJECT_ENVIRONMENT={{ ansible_env.HOME }}/.menv/venvs/mlx-lm uv sync --only-group mlx
  args:
    chdir: "{{ repo_root_path }}"
  changed_when: false
  when: repo_root_path is defined
