---
- name: "Load pipx tools configuration"
  ansible.builtin.include_vars:
    file: "{{ role_path }}/config/common/pipx-tools.yml"
    name: pipx_tools_config

# 1. Check currently installed versions
# check_mode: false is important to ensure this check command runs even in dry-run mode
- name: "Check installed versions of pipx tools"
  ansible.builtin.command:
    cmd: "{{ ansible_env.HOME }}/.local/bin/{{ item.name }} --version"
  loop: "{{ pipx_tools_config.tools }}"
  register: python_pipx_tools_version_check
  changed_when: false
  failed_when: false
  check_mode: false

# 2. Install or update tools
# Only install if versions do not match or tool is not installed
- name: "Install or update pipx tools"
  ansible.builtin.command:
    # Construct pipx install command with spec
    cmd: >
      pipx install --force
      --python {{ ansible_env.HOME }}/.pyenv/versions/{{ item.python_version | default(python_version) }}/bin/python
      {% if item.git is defined %}
      git+{{ item.git }}{% if item.tag is defined %}@{{ item.tag }}{% endif %}
      {% else %}
      {{ item.name }}{% if item.tag is defined %}=={{ item.tag }}{% endif %}
      {% endif %}
  loop: "{{ pipx_tools_config.tools }}"
  loop_control:
    index_var: idx
    label: "{{ item.name }}"
  register: python_pipx_install_result
  changed_when: "'installed package' in python_pipx_install_result.stdout or 'upgraded package' in python_pipx_install_result.stdout"
  # Condition explanation:
  # 1. Command failed (rc != 0) = not installed -> needs installation
  # 2. Tag is defined and the version output does not contain that version number -> needs update
  #    (Note: Remove 'v' from git tag like 'v0.3.0' to compare with '0.3.0')
  when: >
    python_pipx_tools_version_check.results[idx].rc != 0 or
    (
      item.tag is defined and
      item.tag | regex_replace('^v', '') not in python_pipx_tools_version_check.results[idx].stdout
    )

# 3. Run post-install commands (e.g., playwright install)
- name: "Run post-install commands for pipx tools"
  ansible.builtin.shell: "{{ item.post_install }}"
  loop: "{{ pipx_tools_config.tools }}"
  loop_control:
    index_var: idx
    label: "{{ item.name }}"
  changed_when: true
  when: item.post_install is defined

- name: "Ensure menv venv directory exists"
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.menv/venvs"
    state: directory
    mode: "0755"

- name: "Create mlx-lm venv"
  ansible.builtin.shell: |
    uv venv {{ ansible_env.HOME }}/.menv/venvs/mlx-lm
  args:
    creates: "{{ ansible_env.HOME }}/.menv/venvs/mlx-lm"
    chdir: "{{ repo_root_path }}"
  when: repo_root_path is defined

- name: "Install mlx dependency-group into mlx-lm venv"
  ansible.builtin.shell: |
    UV_PROJECT_ENVIRONMENT={{ ansible_env.HOME }}/.menv/venvs/mlx-lm uv sync --only-group mlx
  args:
    chdir: "{{ repo_root_path }}"
  changed_when: false
  when: repo_root_path is defined
