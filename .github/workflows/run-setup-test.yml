name: Run Setup Tests

on:
  workflow_call:
    secrets:
      repo_token:
        description: 'GitHub Token for authentication'
        required: true

jobs:
  setup-test:
    runs-on: macos-latest
    timeout-minutes: 120
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4 # v4ã‚’ä½¿ç”¨
      
      - name: GitHubèªè¨¼ã®è¨­å®š
        run: |
          # GitHubã®èªè¨¼ã‚’è¨­å®š (CIç’°å¢ƒç”¨)
          git config --global url."https://github-actions:${{ secrets.repo_token }}@github.com/".insteadOf "https://github.com/"
          echo "âœ… CIç’°å¢ƒç”¨ã®GitHubèªè¨¼ã‚’è¨­å®šã—ã¾ã—ãŸ"

      - name: CIç’°å¢ƒå¤‰æ•°ã®è¨­å®š
        run: |
          echo "Setting up CI environment variables..."
          # Detect JAVA_HOME based on 'java' executable location if available
          if command -v java &> /dev/null; then
            JAVA_PATH=$(readlink -f $(which java))
            JAVA_HOME_DETECTED=$(dirname $(dirname "$JAVA_PATH"))
            echo "JAVA_HOME=${JAVA_HOME_DETECTED}" >> $GITHUB_ENV
            echo "Detected JAVA_HOME: ${JAVA_HOME_DETECTED}"
          else
            echo "Warning: 'java' command not found, skipping JAVA_HOME detection."
          fi
          echo "ANDROID_SDK_ROOT=${HOME}/Library/Android/sdk" >> $GITHUB_ENV
          echo "REPO_ROOT=${GITHUB_WORKSPACE}" >> $GITHUB_ENV
          echo "IS_CI=true" >> $GITHUB_ENV
          echo "ALLOW_COMPONENT_FAILURE=true" >> $GITHUB_ENV
          echo "GITHUB_TOKEN_CI=${{ secrets.repo_token }}" >> $GITHUB_ENV # Ensure token is available if needed by scripts
          echo "âœ… CIç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¾ã—ãŸ"
        shell: bash

      - name: Install stow
        run: brew install stow

      - name: 1. åˆå›ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
        run: |
          echo "ğŸš€ åˆå›ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™..."
          ./install.sh | tee install_output.log
          
          echo "ğŸ” ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ­ã‚°ã‚’æ¤œè¨¼ä¸­..."
          if grep -q -E '(ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­|ğŸ“¦|ç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—)' install_output.log; then
            echo "âœ… ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¾ã—ãŸ"
          else
            echo "âŒ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            echo "=== ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å‡ºåŠ›ã‚µãƒ³ãƒ—ãƒ« (æœ€åˆã®20è¡Œ) ==="
            head -n 20 install_output.log
            exit 1
          fi
        shell: bash

      - name: 2. å†ªç­‰æ€§ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
        run: |
          echo "ğŸ” å†ªç­‰æ€§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™..."
          export IDEMPOTENT_TEST=true # Enable idempotent mode for install script
          ./install.sh | tee idempotent_output.log
          
          echo "ğŸ” å†ªç­‰æ€§ãƒ­ã‚°ã‚’æ¤œè¨¼ä¸­..."
          # Check that installation messages are NOT present
          if grep -q 'ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­' idempotent_output.log; then
            echo "âŒ å†ªç­‰æ€§ãƒ†ã‚¹ãƒˆå¤±æ•—ï¼š2å›ç›®ã®å®Ÿè¡Œã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
            echo "--- Context ---"
            grep -A 3 -B 3 'ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­' idempotent_output.log
            echo "---------------"
            exit 1
          else
            echo "âœ… ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãªã„ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸ (å†ªç­‰æ€§)"
          fi
          
          # Check that skip messages ARE present
          if grep -q -E '(ã™ã§ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿|ã‚¹ã‚­ãƒƒãƒ—)' idempotent_output.log; then
            echo "âœ… é©åˆ‡ãªã‚¹ã‚­ãƒƒãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç¢ºèªã§ãã¾ã—ãŸ"
          else
            # This might be acceptable depending on the components, treat as warning for now
            echo "âš ï¸ è­¦å‘Šï¼šã‚¹ã‚­ãƒƒãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å†ªç­‰æ€§ã®ç¢ºèªã¯ç¶™ç¶šã—ã¾ã™ã€‚"
          fi
        shell: bash

      - name: Install stow
        run: brew install stow

      - name: 3.1 Verify Shell Setup
        run: |
          echo "ğŸ” ã‚·ã‚§ãƒ«ã®æ¤œè¨¼ã‚’é–‹å§‹..."
          source scripts/utils/helpers.sh
          source scripts/utils/logging.sh
          source scripts/setup/shell.sh
          if verify_shell_setup; then
            log_success "ã‚·ã‚§ãƒ«ã®æ¤œè¨¼ã«æˆåŠŸã—ã¾ã—ãŸ"
          else
            log_error "ã‚·ã‚§ãƒ«ã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi
        shell: bash

      - name: 3.2 Verify Mac Setup
        run: |
          echo "ğŸ” Macã®æ¤œè¨¼ã‚’é–‹å§‹..."
          source scripts/utils/helpers.sh
          source scripts/utils/logging.sh
          source scripts/setup/mac.sh
          if verify_mac_setup; then
            log_success "Macã®æ¤œè¨¼ã«æˆåŠŸã—ã¾ã—ãŸ"
          else
            log_error "Macã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi
        shell: bash

      - name: 3.3 Verify Homebrew Setup
        run: |
          echo "ğŸ” Homebrewã®æ¤œè¨¼ã‚’é–‹å§‹..."
          source scripts/utils/helpers.sh
          source scripts/utils/logging.sh
          source scripts/setup/homebrew.sh
          if verify_homebrew_setup; then
            log_success "Homebrewã®æ¤œè¨¼ã«æˆåŠŸã—ã¾ã—ãŸ"
          else
            log_error "Homebrewã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi
        shell: bash

      - name: 3.4 Verify Xcode Installation
        run: |
          echo "ğŸ” Xcodeã®æ¤œè¨¼ã‚’é–‹å§‹..."
          source scripts/utils/helpers.sh
          source scripts/utils/logging.sh
          source scripts/setup/xcode.sh
          if verify_xcode_installation; then
            log_success "Xcodeã®æ¤œè¨¼ã«æˆåŠŸã—ã¾ã—ãŸ"
          else
            log_error "Xcodeã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi
        shell: bash

      - name: 3.5 Verify Git Setup
        run: |
          echo "ğŸ” Gitã®æ¤œè¨¼ã‚’é–‹å§‹..."
          source scripts/utils/helpers.sh
          source scripts/utils/logging.sh
          source scripts/setup/git.sh
          if verify_git_setup; then
            log_success "Gitã®æ¤œè¨¼ã«æˆåŠŸã—ã¾ã—ãŸ"
          else
            log_error "Gitã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi
        shell: bash

      - name: 3.6 Verify Flutter Setup
        run: |
          echo "ğŸ” Flutterã®æ¤œè¨¼ã‚’é–‹å§‹..."
          source scripts/utils/helpers.sh
          source scripts/utils/logging.sh
          source scripts/setup/flutter.sh
          if verify_flutter_setup; then
            log_success "Flutterã®æ¤œè¨¼ã«æˆåŠŸã—ã¾ã—ãŸ"
          else
            log_error "Flutterã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi
        shell: bash

      - name: 3.7 Verify Neovim Setup
        run: |
          echo "ğŸ” Neovimã®æ¤œè¨¼ã‚’é–‹å§‹..."
          source scripts/utils/helpers.sh
          source scripts/utils/logging.sh
          source scripts/setup/neovim.sh
          # Ensure REPO_ROOT is available for verify_neovim_setup
          export REPO_ROOT="${{ github.workspace }}"
          if verify_neovim_setup; then
            log_success "Neovimã®æ¤œè¨¼ã«æˆåŠŸã—ã¾ã—ãŸ"
          else
            log_error "Neovimã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi
        shell: bash

      - name: 3.8 Verification Summary
        run: |
          echo "======================"
          echo "âœ… All verification steps passed successfully!"
          echo "ğŸ‰ ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼"
        shell: bash 