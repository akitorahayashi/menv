# This file is auto-generated. Do not edit manually.
# Jules Agent Orchestration
#
# Orchestrates scheduled/dispatch layer execution in sequence.
# Implementer PR metadata and auto-merge are delegated to dedicated workflows.
# Layer/task orchestration is command-driven through `jlo workflow`.

name: Jules Scheduled Workflows

on:
  schedule:

    - cron: '0 19 * * *'

  workflow_dispatch:
    inputs:
      entry_point:
        description: 'Start from layer'
        type: choice
        options:
          - narrator
          - innovators
          - observers
          - decider
          - requirements
        default: narrator
      wait_minutes:
        description: 'Minutes to wait between layers (Jules async processing time)'
        type: number
        default: 30
      mock:
        description: 'Run in mock mode (creates branches/PRs without Jules API)'
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: 'jules-orchestration'
  cancel-in-progress: false

env:
  WAIT_MINUTES: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.wait_minutes || 30) || 30 }}
  MOCK_MODE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mock == 'true' || false }}
  JULES_MOCK_TAG: ${{ format('mock-run-{0}', github.run_id) }}
  JLO_RUN_FLAGS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mock == 'true' && '--mock' || '' }}
  JLO_TARGET_BRANCH: 'main'
  JULES_WORKER_BRANCH: 'jules'


jobs:
  # ============================================================
  # Phase 0: Bootstrap runtime repository on worker branch
  # ============================================================
  bootstrap:
    if: >-
      (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') &&
      ((vars.JLO_PAUSED || 'false') != 'true' || github.event_name != 'schedule')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
    steps:
      - name: Validate branch variables
        run: |
          set -euo pipefail
          if [ -z "${JLO_TARGET_BRANCH:-}" ]; then
            echo "::error::JLO_TARGET_BRANCH is required."
            exit 1
          fi
          if [ -z "${JULES_WORKER_BRANCH:-}" ]; then
            echo "::error::JULES_WORKER_BRANCH is required."
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          ref: 'main'
          fetch-depth: 0
          token: ${{ secrets.JLO_BOT_TOKEN }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Ensure worker branch
        run: |
          set -euo pipefail
          if git ls-remote --exit-code --heads origin "${JULES_WORKER_BRANCH}" >/dev/null 2>&1; then
            echo "${JULES_WORKER_BRANCH} branch exists, checking out"
            git fetch origin "${JULES_WORKER_BRANCH}"
            git checkout -B "${JULES_WORKER_BRANCH}" "origin/${JULES_WORKER_BRANCH}"
          else
            echo "Creating ${JULES_WORKER_BRANCH} from ${JLO_TARGET_BRANCH}"
            git checkout -B "${JULES_WORKER_BRANCH}" "origin/${JLO_TARGET_BRANCH}"
          fi

      - name: Merge target branch into worker
        run: |
          set -euo pipefail
          git fetch origin "$JLO_TARGET_BRANCH"
          # Merge control branch, preferring control-plane code changes.
          git merge "origin/$JLO_TARGET_BRANCH" --no-edit -X theirs --allow-unrelated-histories || {
            # On conflict, preserve runtime plane from the worker branch.
            git checkout --ours .jules/
            git add .jules/
            if git diff --cached --quiet; then
              echo "::error::Merge failed and no conflict resolution changes were staged."
              exit 1
            fi
            git commit --no-edit
          }

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Bootstrap runtime repository
        run: jlo workflow bootstrap

      - name: Commit and push changes
        id: bootstrap
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain .jules)" ]; then
            git add .jules/
            git commit -m "chore: bootstrap .jules/ runtime repository [jlo $(jlo --version | awk '{print $2}')]"
            git push origin "${JULES_WORKER_BRANCH}"
            echo "committed=true" >> "$GITHUB_OUTPUT"
          else
            echo "committed=false" >> "$GITHUB_OUTPUT"
          fi


  # ============================================================
  # Phase 1: Check schedule
  # ============================================================
  check-schedule:
    needs: [bootstrap]
    if: |
      needs.bootstrap.result == 'success' &&
      ((vars.JLO_PAUSED || 'false') != 'true' || github.event_name != 'schedule') &&
      (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      json: ${{ steps.check.outputs.json }}
    steps:
      - name: Check schedule
        id: check
        env:
          ENTRY_POINT: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.entry_point || 'narrator') || 'narrator' }}
        run: |
          set -euo pipefail
          run_narrator=false
          run_innovators=false
          run_observers=false
          run_decider=false
          run_planner=false
          run_implementer=false

          case "${ENTRY_POINT}" in
            narrator)
              run_narrator=true
              run_observers=true
              run_decider=true
              run_planner=true
              run_implementer=true
              ;;
            innovators)
              run_innovators=true
              ;;
            observers)
              run_observers=true
              run_decider=true
              run_planner=true
              run_implementer=true
              ;;
            decider)
              run_decider=true
              run_planner=true
              run_implementer=true
              ;;
            requirements)
              run_planner=true
              run_implementer=true
              ;;
            *)
              echo "::error::Unsupported entry_point '${ENTRY_POINT}'. Allowed values: narrator, innovators, observers, decider, requirements."
              exit 1
              ;;
          esac

          echo "json={\"should_run\":true,\"entry_point\":\"${ENTRY_POINT}\",\"run_narrator\":${run_narrator},\"run_innovators\":${run_innovators},\"run_observers\":${run_observers},\"run_decider\":${run_decider},\"run_planner\":${run_planner},\"run_implementer\":${run_implementer}}" >> "$GITHUB_OUTPUT"


  # ============================================================
  # Phase 2: Run narrator (changes feed generation)
  # ============================================================
  run-narrator:
    needs: [check-schedule]
    if: >-
      needs.check-schedule.result == 'success' &&
      fromJSON(needs.check-schedule.outputs.json).run_narrator == true
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      json: ${{ steps.run.outputs.json }}
    env:
      JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: 'jules'
          fetch-depth: 0
          token: ${{ secrets.JLO_BOT_TOKEN }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Run narrator
        id: run
        run: jlo workflow run narrator ${{ env.JLO_RUN_FLAGS }}

      - name: Validate repository (fail-fast)
        run: jlo doctor

  # ============================================================
  # Phase 3: Run innovators (proposal generation)
  # ============================================================
  run-innovators:
    needs: [bootstrap]
    if: |
      needs.bootstrap.result == 'success' &&
      ((vars.JLO_PAUSED || 'false') != 'true' || github.event_name != 'schedule') &&
      (
        github.event_name == 'schedule' ||
        (
          github.event_name == 'workflow_dispatch' &&
          (github.event.inputs.entry_point || 'narrator') == 'innovators'
        )
      )
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      json: ${{ steps.run.outputs.json }}
    env:
      JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: 'jules'
          fetch-depth: 0
          token: ${{ secrets.JLO_BOT_TOKEN }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Run innovators
        id: run
        run: |
          set -euo pipefail
          jlo workflow run innovators ${{ env.JLO_RUN_FLAGS }} --task create_three_proposals

  # ============================================================
  # Phase 4: Wait for innovators processing
  # ============================================================
  wait-after-run-innovators:
    needs: [run-innovators]
    if: |
      needs.run-innovators.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      json: ${{ steps.wait.outputs.json }}
    steps:
      - name: Wait ${{ env.WAIT_MINUTES }} minutes for Jules async processing
        id: wait
        shell: bash
        run: |
          set -euo pipefail
          trap 'echo "Cancellation detected. Exiting wait early."; exit 130' INT TERM

          if [ "${{ env.MOCK_MODE }}" = "true" ]; then
            TOTAL_SECONDS=15
            echo "Mock mode enabled: overriding wait to 15 seconds."
          else
            TOTAL_SECONDS=$((${{ env.WAIT_MINUTES }} * 60))
          fi

          if [ "$TOTAL_SECONDS" -le 0 ]; then
            echo "Wait skipped (TOTAL_SECONDS=$TOTAL_SECONDS)."
            echo "json={}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Waiting ${TOTAL_SECONDS} seconds for Jules to process innovators..."
          ELAPSED=0
          INTERVAL=5
          while [ $ELAPSED -lt $TOTAL_SECONDS ]; do
            STEP=$INTERVAL
            REMAINING=$((TOTAL_SECONDS - ELAPSED))
            if [ "$REMAINING" -lt "$STEP" ]; then
              STEP=$REMAINING
            fi
            sleep "$STEP" &
            wait $!
            ELAPSED=$((ELAPSED + STEP))
            echo "[$ELAPSED/$TOTAL_SECONDS seconds]"
          done
          echo "Wait complete."
          echo "json={}" >> "$GITHUB_OUTPUT"

  # ============================================================
  # Phase 5: Publish innovators proposals
  # ============================================================
  publish-proposals:
    needs: [wait-after-run-innovators]
    if: |
      needs.wait-after-run-innovators.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: 'jules'
          fetch-depth: 0
          token: ${{ secrets.JLO_BOT_TOKEN }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Publish proposals
        run: jlo workflow exchange publish-proposals

  # ============================================================
  # Phase 6: Wait for narrator processing
  # ============================================================
  wait-after-initial-requests:
    needs: [check-schedule, run-narrator]
    if: |
      always() &&
      needs.check-schedule.result == 'success' &&
      (
        (
          fromJSON(needs.check-schedule.outputs.json).run_narrator == true &&
          needs.run-narrator.result == 'success'
        ) ||
        (
          fromJSON(needs.check-schedule.outputs.json).run_narrator == false &&
          needs.run-narrator.result == 'skipped'
        )
      )
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      json: ${{ steps.wait.outputs.json }}
    steps:
      - name: Wait ${{ env.WAIT_MINUTES }} minutes for Jules async processing
        id: wait
        shell: bash
        run: |
          set -euo pipefail
          trap 'echo "Cancellation detected. Exiting wait early."; exit 130' INT TERM

          if [ "${{ env.MOCK_MODE }}" = "true" ]; then
            TOTAL_SECONDS=15
            echo "Mock mode enabled: overriding wait to 15 seconds."
          else
            TOTAL_SECONDS=$((${{ env.WAIT_MINUTES }} * 60))
          fi

          if [ "$TOTAL_SECONDS" -le 0 ]; then
            echo "Wait skipped (TOTAL_SECONDS=$TOTAL_SECONDS)."
            echo "json={}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Waiting ${TOTAL_SECONDS} seconds for Jules to process narrator..."
          ELAPSED=0
          INTERVAL=5
          while [ $ELAPSED -lt $TOTAL_SECONDS ]; do
            STEP=$INTERVAL
            REMAINING=$((TOTAL_SECONDS - ELAPSED))
            if [ "$REMAINING" -lt "$STEP" ]; then
              STEP=$REMAINING
            fi
            sleep "$STEP" &
            wait $!
            ELAPSED=$((ELAPSED + STEP))
            echo "[$ELAPSED/$TOTAL_SECONDS seconds]"
          done
          echo "Wait complete."
          echo "json={}" >> "$GITHUB_OUTPUT"

  # ============================================================
  # Phase 7: Run observers
  # ============================================================

  run-observers:
    needs: ["check-schedule", "wait-after-initial-requests"]
    if: |
      fromJSON(needs.check-schedule.outputs.json).run_observers == true &&
            needs.wait-after-initial-requests.result == 'success'

    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      json: ${{ steps.run.outputs.json }}
    env:
      JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: 'jules'
          fetch-depth: 0
          token: ${{ secrets.JLO_BOT_TOKEN }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Run observers
        id: run
        run: |
          set -euo pipefail
          jlo workflow run observers ${{ env.JLO_RUN_FLAGS }}
  # ============================================================
  # Phase 8: Wait for observer processing
  # ============================================================

  wait-after-observers:
    needs: run-observers
    if: |
      needs.run-observers.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      json: ${{ steps.wait.outputs.json }}
    steps:
      - name: Wait ${{ env.WAIT_MINUTES }} minutes for Jules async processing
        id: wait
        shell: bash
        run: |
          set -euo pipefail
          trap 'echo "Cancellation detected. Exiting wait early."; exit 130' INT TERM

          if [ "${{ env.MOCK_MODE }}" = "true" ]; then
            TOTAL_SECONDS=15
            echo "Mock mode enabled: overriding wait to 15 seconds."
          else
            TOTAL_SECONDS=$((${{ env.WAIT_MINUTES }} * 60))
          fi

          if [ "$TOTAL_SECONDS" -le 0 ]; then
            echo "Wait skipped (TOTAL_SECONDS=$TOTAL_SECONDS)."
            echo "json={}" >> "$GITHUB_OUTPUT"
            exit 0
          fi
            echo "Waiting ${TOTAL_SECONDS} seconds for Jules to process observers..."
          ELAPSED=0
          INTERVAL=5
          while [ $ELAPSED -lt $TOTAL_SECONDS ]; do
            STEP=$INTERVAL
            REMAINING=$((TOTAL_SECONDS - ELAPSED))
            if [ "$REMAINING" -lt "$STEP" ]; then
              STEP=$REMAINING
            fi
            sleep "$STEP" &
            wait $!
            ELAPSED=$((ELAPSED + STEP))
            echo "[$ELAPSED/$TOTAL_SECONDS seconds]"
          done
          echo "Wait complete."
          echo "json={}" >> "$GITHUB_OUTPUT"
  # ============================================================
  # Phase 9: Check for pending events (decider gate)
  # ============================================================
  generate-decider-matrix:
    needs: [check-schedule, wait-after-observers]
    if: |
      always() &&
      needs.check-schedule.result == 'success' &&
      fromJSON(needs.check-schedule.outputs.json).run_decider == true &&
      (
        (
          fromJSON(needs.check-schedule.outputs.json).run_observers == true &&
          needs.wait-after-observers.result == 'success'
        ) ||
        (
          fromJSON(needs.check-schedule.outputs.json).run_observers == false &&
          needs.wait-after-observers.result == 'skipped'
        )
      )
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      json: ${{ steps.matrix.outputs.json }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: 'jules'
          fetch-depth: 0

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Check for pending events
        id: matrix
        env:
          REQUEST_DECIDER: ${{ fromJSON(needs.check-schedule.outputs.json).run_decider }}
        run: |
          set -euo pipefail
          HAS_PENDING=$(jlo workflow exchange inspect | jq '(.events.pending_files | length) > 0')
          RUN_DECIDER=false
          if [ "$REQUEST_DECIDER" = "true" ] && [ "$HAS_PENDING" = "true" ]; then
            RUN_DECIDER=true
          fi
          echo "json={\"has_pending\":$HAS_PENDING,\"run_decider\":$RUN_DECIDER}" >> "$GITHUB_OUTPUT"


  # ============================================================
  # Phase 10: Run decider
  # ============================================================

  run-decider:
    needs: [generate-decider-matrix]
    if: |
      needs.generate-decider-matrix.result == 'success' &&
            fromJSON(needs.generate-decider-matrix.outputs.json).run_decider == true

    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      json: ${{ steps.run.outputs.json }}
    env:
      JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: 'jules'
          fetch-depth: 0
          token: ${{ secrets.JLO_BOT_TOKEN }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Run decider
        id: run
        run: |
          set -euo pipefail
          jlo workflow run decider ${{ env.JLO_RUN_FLAGS }}
  # ============================================================
  # Phase 11: Wait for decider processing
  # ============================================================

  wait-after-decider:
    needs: run-decider
    if: |
      needs.run-decider.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      json: ${{ steps.wait.outputs.json }}
    steps:
      - name: Wait ${{ env.WAIT_MINUTES }} minutes for Jules async processing
        id: wait
        shell: bash
        run: |
          set -euo pipefail
          trap 'echo "Cancellation detected. Exiting wait early."; exit 130' INT TERM

          if [ "${{ env.MOCK_MODE }}" = "true" ]; then
            TOTAL_SECONDS=15
            echo "Mock mode enabled: overriding wait to 15 seconds."
          else
            TOTAL_SECONDS=$((${{ env.WAIT_MINUTES }} * 60))
          fi

          if [ "$TOTAL_SECONDS" -le 0 ]; then
            echo "Wait skipped (TOTAL_SECONDS=$TOTAL_SECONDS)."
            echo "json={}" >> "$GITHUB_OUTPUT"
            exit 0
          fi
            echo "Waiting ${TOTAL_SECONDS} seconds for Jules to process decider..."
          ELAPSED=0
          INTERVAL=5
          while [ $ELAPSED -lt $TOTAL_SECONDS ]; do
            STEP=$INTERVAL
            REMAINING=$((TOTAL_SECONDS - ELAPSED))
            if [ "$REMAINING" -lt "$STEP" ]; then
              STEP=$REMAINING
            fi
            sleep "$STEP" &
            wait $!
            ELAPSED=$((ELAPSED + STEP))
            echo "[$ELAPSED/$TOTAL_SECONDS seconds]"
          done
          echo "Wait complete."
          echo "json={}" >> "$GITHUB_OUTPUT"
  # ============================================================
  # Phase 12: Resolve planner/implementer run requests
  # ============================================================
  generate-routing-matrix:
    needs: [check-schedule, generate-decider-matrix, run-decider, wait-after-decider]
    if: |
      always() &&
      needs.check-schedule.result == 'success' &&
      (fromJSON(needs.check-schedule.outputs.json).run_planner == true || fromJSON(needs.check-schedule.outputs.json).run_implementer == true) &&
      (
        (
          fromJSON(needs.check-schedule.outputs.json).run_decider == false &&
          needs.generate-decider-matrix.result == 'skipped' &&
          needs.run-decider.result == 'skipped' &&
          needs.wait-after-decider.result == 'skipped'
        ) ||
        (
          fromJSON(needs.check-schedule.outputs.json).run_decider == true &&
          needs.generate-decider-matrix.result == 'success' &&
          (
            (
              needs.run-decider.result == 'success' &&
              needs.wait-after-decider.result == 'success'
            ) ||
            (
              needs.run-decider.result == 'skipped' &&
              needs.wait-after-decider.result == 'skipped'
            )
          )
        )
      )
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      json: ${{ steps.matrix.outputs.json }}
    steps:
      - name: Resolve planner/implementer run requests
        id: matrix
        env:
          REQUEST_PLANNER: ${{ fromJSON(needs.check-schedule.outputs.json).run_planner }}
          REQUEST_IMPLEMENTER: ${{ fromJSON(needs.check-schedule.outputs.json).run_implementer }}
        run: |
          set -euo pipefail
          echo "json={\"run_planner\":$REQUEST_PLANNER,\"run_implementer\":$REQUEST_IMPLEMENTER}" >> "$GITHUB_OUTPUT"


  # ============================================================
  # Phase 13: Run planner
  # ============================================================

  run-planner:
    needs: [generate-routing-matrix]
    if: |
      needs.generate-routing-matrix.result == 'success' &&
            fromJSON(needs.generate-routing-matrix.outputs.json).run_planner == true

    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      json: ${{ steps.run.outputs.json }}
    env:
      JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: 'jules'
          fetch-depth: 0
          token: ${{ secrets.JLO_BOT_TOKEN }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Run planner
        id: run
        run: |
          set -euo pipefail
          jlo workflow run planner ${{ env.JLO_RUN_FLAGS }}
  # ============================================================
  # Phase 14: Wait for planner PRs
  # ============================================================

  wait-after-planner:
    needs: run-planner
    if: |
      needs.run-planner.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      json: ${{ steps.wait.outputs.json }}
    steps:
      - name: Wait ${{ env.WAIT_MINUTES }} minutes for Jules async processing
        id: wait
        shell: bash
        run: |
          set -euo pipefail
          trap 'echo "Cancellation detected. Exiting wait early."; exit 130' INT TERM

          if [ "${{ env.MOCK_MODE }}" = "true" ]; then
            TOTAL_SECONDS=15
            echo "Mock mode enabled: overriding wait to 15 seconds."
          else
            TOTAL_SECONDS=$((${{ env.WAIT_MINUTES }} * 60))
          fi

          if [ "$TOTAL_SECONDS" -le 0 ]; then
            echo "Wait skipped (TOTAL_SECONDS=$TOTAL_SECONDS)."
            echo "json={}" >> "$GITHUB_OUTPUT"
            exit 0
          fi
            echo "Waiting ${TOTAL_SECONDS} seconds for Jules to process planner..."
          ELAPSED=0
          INTERVAL=5
          while [ $ELAPSED -lt $TOTAL_SECONDS ]; do
            STEP=$INTERVAL
            REMAINING=$((TOTAL_SECONDS - ELAPSED))
            if [ "$REMAINING" -lt "$STEP" ]; then
              STEP=$REMAINING
            fi
            sleep "$STEP" &
            wait $!
            ELAPSED=$((ELAPSED + STEP))
            echo "[$ELAPSED/$TOTAL_SECONDS seconds]"
          done
          echo "Wait complete."
          echo "json={}" >> "$GITHUB_OUTPUT"
  # ============================================================
  # Phase 15: Run implementer
  # ============================================================

  run-implementer:
    needs: [generate-routing-matrix]
    if: |
      needs.generate-routing-matrix.result == 'success' &&
            fromJSON(needs.generate-routing-matrix.outputs.json).run_implementer == true

    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      json: ${{ steps.run.outputs.json }}
    env:
      JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
      TARGET_BRANCH: 'main'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: 'jules'
          fetch-depth: 0
          token: ${{ secrets.JLO_BOT_TOKEN }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Run implementer
        id: run
        run: |
          set -euo pipefail
          jlo workflow run implementer ${{ env.JLO_RUN_FLAGS }}
  # ============================================================
  # Phase 16: Wait for implementer labels
  # ============================================================

  wait-after-implementer:
    needs: run-implementer
    if: |
      needs.run-implementer.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      json: ${{ steps.wait.outputs.json }}
    steps:
      - name: Wait ${{ env.WAIT_MINUTES }} minutes for Jules async processing
        id: wait
        shell: bash
        run: |
          set -euo pipefail
          trap 'echo "Cancellation detected. Exiting wait early."; exit 130' INT TERM

          if [ "${{ env.MOCK_MODE }}" = "true" ]; then
            TOTAL_SECONDS=15
            echo "Mock mode enabled: overriding wait to 15 seconds."
          else
            TOTAL_SECONDS=$((${{ env.WAIT_MINUTES }} * 60))
          fi

          if [ "$TOTAL_SECONDS" -le 0 ]; then
            echo "Wait skipped (TOTAL_SECONDS=$TOTAL_SECONDS)."
            echo "json={}" >> "$GITHUB_OUTPUT"
            exit 0
          fi
            echo "Waiting ${TOTAL_SECONDS} seconds for Jules to process implementer..."
          ELAPSED=0
          INTERVAL=5
          while [ $ELAPSED -lt $TOTAL_SECONDS ]; do
            STEP=$INTERVAL
            REMAINING=$((TOTAL_SECONDS - ELAPSED))
            if [ "$REMAINING" -lt "$STEP" ]; then
              STEP=$REMAINING
            fi
            sleep "$STEP" &
            wait $!
            ELAPSED=$((ELAPSED + STEP))
            echo "[$ELAPSED/$TOTAL_SECONDS seconds]"
          done
          echo "Wait complete."
          echo "json={}" >> "$GITHUB_OUTPUT"

  # ============================================================
  # Phase 17: Cleanup mock artifacts
  # ============================================================
  cleanup-mock-artifacts:
    needs: [publish-proposals, wait-after-planner, wait-after-implementer]
    if: |
      always() &&
      (github.event_name == 'workflow_dispatch' && github.event.inputs.mock == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
      GITHUB_REPOSITORY: ${{ github.repository }}
    steps:
      - name: Validate branch variables
        run: |
          set -euo pipefail
          if [ -z "${JLO_TARGET_BRANCH:-}" ]; then
            echo "::error::JLO_TARGET_BRANCH is required."
            exit 1
          fi
          if [ -z "${JULES_WORKER_BRANCH:-}" ]; then
            echo "::error::JULES_WORKER_BRANCH is required."
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          ref: 'jules'
          fetch-depth: 0
          token: ${{ secrets.JLO_BOT_TOKEN }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Cleanup mock artifacts for this run
        run: |
          # Cleanup uses a PR merge path to satisfy branch protection and preserve auditable history.
          # Auto-merge is not enabled here; authority is centralized in jules-automerge workflow.
          jlo workflow exchange clean mock --mock-tag "$JULES_MOCK_TAG"

