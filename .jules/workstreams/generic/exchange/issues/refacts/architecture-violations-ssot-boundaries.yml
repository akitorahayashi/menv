schema_version: 2

# Metadata
id: "arc7v2"
source_events:
  - "g7h8i9"
  - "d2k4m1"
  - "d7k2m9"
  - "d4e5f6"
  - "x4p1q8"
title: "Architecture Violations: SSOT and Boundary Leaks"
label: "refacts"
priority: "high"
summary: "Domain logic leaks into CLI and config paths are hardcoded, violating SSOT."

# Content
problem: |
  Core domain logic, specifically the definition of 'Tag Groups' and 'Valid Profiles', is currently defined directly in the CLI command modules (e.g., `src/menv/commands/make.py`). This violates the boundary between the presentation layer (CLI) and the domain layer.

  Additionally, the local configuration root path (e.g., `~/.config/menv`) is hardcoded redundantly across multiple services (`ConfigStorage`, `AnsibleRunner`, `ConfigDeployer`), violating the Single Source of Truth (SSOT) principle.

impact: |
  - **High Coupling:** Changes to domain rules (e.g., adding a profile) require modifying CLI code.
  - **Maintenance Fragility:** Changing the config path requires updates in multiple places, increasing the risk of inconsistency.
  - **Testing Difficulty:** Domain rules cannot be tested in isolation from the CLI.

desired_outcome: |
  - Domain definitions (Tag Groups, Profiles) are moved to a shared domain model (e.g., `src/menv/models/domain.py` or similar).
  - Configuration paths are centralized in a single configuration service or constant definition (SSOT).
  - CLI and Services import these definitions from the shared source.

constraints: []
risks: []

# Specifics
affected_areas:
  - "src/menv/commands/make.py"
  - "src/menv/commands/create.py"
  - "src/menv/services/ansible_runner.py"
  - "src/menv/services/config_deployer.py"
  - "src/menv/services/config_storage.py"

acceptance_criteria:
  - "Tag Groups and Valid Profiles are defined in a shared domain module."
  - "CLI commands import Tag Groups and Profiles from the shared module."
  - "Local configuration root path is defined in exactly one place."
  - "All services reference the single configuration path definition."

verification_commands:
  - "grep -r 'TAG_GROUPS' src/menv/commands/"
  - "grep -r '.config/menv' src/menv/services/"

# Analysis Flags
requires_deep_analysis: false
deep_analysis_reason: ""
