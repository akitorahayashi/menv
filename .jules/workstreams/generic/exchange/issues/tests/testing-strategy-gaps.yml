schema_version: 2

# Metadata
id: "tst2j9"
source_events:
  - "92nxg4"
  - "fev6uq"
  - "qa0001"
  - "qa0002"
title: "Critical Testing Gaps and Anti-Patterns"
label: "tests"
priority: "high"
summary: "Low coverage in critical paths and unsafe testing patterns (Mirror Logic)."

# Content
problem: |
  The current testing strategy has significant gaps and flaws:
  1. **Low Coverage:** Key CLI commands (`update`, `switch`, `create`) and the core `AnsibleRunner.run_playbook` method have very low coverage (< 35%), leaving critical user interactions untested.
  2. **Mirror Logic:** Integration tests (e.g., `test_role_integrity.py`) re-implement Ansible's logic in Python to validate static files. This validates the test author's understanding of Ansible, not the actual Ansible execution.
  3. **No Runtime Verification:** There are no tests that actually execute `ansible-playbook`, even in `--check` mode, meaning runtime errors (syntax, module args) are not caught.

impact: |
  - **Risk of Regression:** Core features could break without detection.
  - **False Security:** "Mirror Logic" tests might pass even if the Playbook is broken.
  - **Maintenance Burden:** Re-implementing Ansible logic in tests is hard to maintain.

desired_outcome: |
  - Implement integration tests that invoke the CLI commands and `AnsibleRunner` (mocking subprocess where appropriate but verifying the call).
  - Replace "Mirror Logic" tests with `ansible-playbook --syntax-check` or `--check` (dry-run) where feasible.
  - Increase coverage for `update`, `switch`, `create`, and `run_playbook`.

constraints: []
risks: []

# Specifics
affected_areas:
  - "src/menv/commands/update.py"
  - "src/menv/commands/switch.py"
  - "src/menv/commands/create.py"
  - "src/menv/services/ansible_runner.py"
  - "tests/intg/test_role_integrity.py"

acceptance_criteria:
  - "CLI commands have integration tests ensuring they call the runner correctly."
  - "AnsibleRunner has tests verifying exception handling and subprocess calls."
  - "Ansible roles are verified using standard Ansible tooling (syntax-check/lint) instead of custom Python logic."

verification_commands:
  - "pytest --cov=src/menv/commands"

# Analysis Flags
requires_deep_analysis: false
deep_analysis_reason: ""
