---
- name: "Load rust tools configuration"
  ansible.builtin.include_vars:
    file: "{{ local_config_root }}/rust/common/tools.yml"
    name: rust_tools_config

- name: "Load platform mapping configuration"
  ansible.builtin.include_vars:
    file: "{{ local_config_root }}/rust/common/platforms.yml"
    name: platform_config

- name: "Set platform variables"
  ansible.builtin.set_fact:
    platform_os: "{{ platform_config.os_mapping[ansible_system] | default('') }}"
    platform_arch: "{{ platform_config.arch_mapping[ansible_architecture] | default('') }}"

- name: "Fail if platform is unsupported"
  ansible.builtin.fail:
    msg: "Unsupported platform: {{ ansible_system }}/{{ ansible_architecture }}. Supported: Darwin/Linux with x86_64/aarch64/arm64."
  when: platform_os == '' or platform_arch == ''

- name: "Check installed versions of rust tools"
  ansible.builtin.command:
    cmd: "{{ ansible_env.HOME }}/.cargo/bin/{{ item.name }} --version"
  loop: "{{ rust_tools_config.tools }}"
  register: rust_tools_version_check
  changed_when: false
  failed_when: false
  check_mode: false

- name: "Download and install rust tools from GitHub releases"
  ansible.builtin.get_url:
    url: "https://github.com/{{ item.repo }}/releases/download/{{ item.tag }}/{{ item.name }}-{{ platform_os }}-{{ platform_arch }}"
    dest: "{{ ansible_env.HOME }}/.cargo/bin/{{ item.name }}"
    mode: "0755"
    force: true
  loop: "{{ rust_tools_config.tools }}"
  loop_control:
    index_var: idx
    label: "{{ item.name }}"
  when: >
    rust_tools_version_check.results[idx].rc != 0 or
    (
      item.tag is defined and
      item.tag | regex_replace('^v', '') not in rust_tools_version_check.results[idx].stdout
    )
  register: rust_tools_download_result

- name: "Report failed downloads"
  ansible.builtin.fail:
    msg: "Failed to download {{ item.item.name }} from {{ item.item.repo }}. Asset may not exist for this platform."
  loop: "{{ rust_tools_download_result.results }}"
  loop_control:
    label: "{{ item.item.name }}"
  when:
    - item.failed is defined
    - item.failed
