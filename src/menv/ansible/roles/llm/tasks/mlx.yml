---
# MLX Model Management
# Tags:
#   - mlx-models: Download models via huggingface-cli

# Model download tasks (only for mlx-models tag)
- name: "Load common models configuration"
  ansible.builtin.include_vars:
    file: "{{ local_config_root }}/llm/common/models.yml"
    name: llm_common_models_mlx
  when: "'mlx-models' in ansible_run_tags"

- name: "Load profile models configuration"
  ansible.builtin.include_vars:
    file: "{{ local_config_root }}/llm/profiles/{{ profile }}/models.yml"
    name: llm_profile_models_mlx
  when: "'mlx-models' in ansible_run_tags and profile is defined"
  failed_when: false

- name: "Set MLX models to download"
  ansible.builtin.set_fact:
    llm_mlx_models_to_download: "{{ (llm_common_models_mlx.mlx | default([])) + (llm_profile_models_mlx.mlx | default([])) }}"
  when: "'mlx-models' in ansible_run_tags"

- name: "Download MLX models via huggingface-cli"
  ansible.builtin.command:
    cmd: "{{ ansible_env.HOME }}/.local/bin/huggingface-cli download {{ item }}"
  loop: "{{ llm_mlx_models_to_download | default([]) }}"
  register: llm_mlx_download_result
  changed_when: "'Downloading' in llm_mlx_download_result.stderr or 'Fetching' in llm_mlx_download_result.stderr"
  when: "'mlx-models' in ansible_run_tags and (llm_mlx_models_to_download | default([]) | length) > 0"
