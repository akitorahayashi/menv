---
- name: "Set Node.js bin path"
  ansible.builtin.set_fact:
    nodejs_bin_path: "{{ ansible_env.HOME }}/.nvm/versions/node/v{{ nodejs_version }}/bin"

- name: "Install LLM CLI tools via npm"
  community.general.npm:
    name: "{{ item }}"
    version: "latest"
    global: true
    executable: "{{ nodejs_bin_path }}/npm"
  loop:
    - "@openai/codex"
    - "@anthropic-ai/claude-code"
    - "@google/gemini-cli"
  environment:
    PATH: "{{ nodejs_bin_path }}:{{ ansible_env.PATH }}"

- name: "Ensure Claude configuration directory exists"
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.claude"
    state: directory
    mode: "0755"

- name: "Symlink Claude settings.json"
  ansible.builtin.file:
    src: "{{ local_config_root }}/nodejs/common/coder/claude.json"
    dest: "{{ ansible_env.HOME }}/.claude/settings.json"
    state: link
    force: true
    mode: "0644"

- name: "Symlink Claude AGENTS file"
  ansible.builtin.file:
    src: "{{ local_config_root }}/nodejs/common/coder/AGENTS.md"
    dest: "{{ ansible_env.HOME }}/.claude/CLAUDE.md"
    state: link
    force: true
    mode: "0644"

- name: "Create Claude commands directory"
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.claude/commands"
    state: directory
    mode: "0755"

- name: "Ensure Gemini configuration directory exists"
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.gemini"
    state: directory
    mode: "0755"

- name: "Symlink Gemini settings.json"
  ansible.builtin.file:
    src: "{{ local_config_root }}/nodejs/common/coder/gemini.json"
    dest: "{{ ansible_env.HOME }}/.gemini/settings.json"
    state: link
    force: true
    mode: "0644"

- name: "Symlink Gemini AGENTS file"
  ansible.builtin.file:
    src: "{{ local_config_root }}/nodejs/common/coder/AGENTS.md"
    dest: "{{ ansible_env.HOME }}/.gemini/GEMINI.md"
    state: link
    force: true
    mode: "0644"

- name: "Check if Gemini CLI is available"
  ansible.builtin.command: which gemini
  register: nodejs_gemini_cli_check
  failed_when: false
  changed_when: false
  environment:
    PATH: "{{ nodejs_bin_path }}:{{ ansible_env.PATH }}"

- name: "Warning if Gemini CLI not available"
  ansible.builtin.debug:
    msg: "Gemini CLI not found. Configuration files copied but MCP servers not installed via CLI."
  when: nodejs_gemini_cli_check.rc != 0

- name: "Create Gemini commands directory"
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.gemini/commands"
    state: directory
    mode: "0755"

- name: "Ensure Codex configuration directories exist"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ ansible_env.HOME }}/.codex"
    - "{{ ansible_env.HOME }}/.codex/prompts"

- name: "Symlink Codex configuration file"
  ansible.builtin.file:
    src: "{{ local_config_root }}/nodejs/common/coder/codex.toml"
    dest: "{{ ansible_env.HOME }}/.codex/config.toml"
    state: link
    force: true
    mode: "0644"

- name: "Symlink Codex AGENTS file"
  ansible.builtin.file:
    src: "{{ local_config_root }}/nodejs/common/coder/AGENTS.md"
    dest: "{{ ansible_env.HOME }}/.codex/AGENTS.md"
    state: link
    force: true
    mode: "0644"

- name: "Load agent skills targets"
  ansible.builtin.set_fact:
    nodejs_coder_skills_targets: "{{ lookup('file', local_config_root + '/nodejs/common/coder/skills-targets.yml') | from_yaml }}"

- name: "Discover common agent skills"
  ansible.builtin.find:
    paths: "{{ local_config_root }}/nodejs/common/coder/skills"
    file_type: directory
    depth: 1
  register: nodejs_coder_skills_find

- name: "Set agent skills list"
  ansible.builtin.set_fact:
    nodejs_coder_skills: "{{ nodejs_coder_skills_find.files | map(attribute='path') | map('basename') | list }}"

- name: "Ensure agent skills directories exist"
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.{{ item }}/skills"
    state: directory
    mode: "0755"
  loop: "{{ nodejs_coder_skills_targets.tools }}"

- name: "Deploy common agent skills to all CLIs"
  ansible.builtin.file:
    src: "{{ local_config_root }}/nodejs/common/coder/skills/{{ item.0 }}"
    dest: "{{ ansible_env.HOME }}/.{{ item.1 }}/skills/{{ item.0 }}"
    state: link
    force: true
  loop: "{{ nodejs_coder_skills | product(nodejs_coder_skills_targets.tools) | list }}"
